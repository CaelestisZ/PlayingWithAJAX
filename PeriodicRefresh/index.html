<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Periodic Refresh</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.0/css/bulma.min.css">

    <script>

        jsonarr = {};
        n = 2;

        var obj = {
            xhr: new XMLHttpRequest(),

            // Send request to get JSON from index.php
            getJSON : function() {
                this.xhr.onreadystatechange = this.updateMatrix;
                this.xhr.timeout = 5000;
                this.xhr.ontimeout = this.backoff;
                this.xhr.open("GET", "index.php?jsonarr="+JSON.stringify(jsonarr), true);
                this.xhr.send();
            },

            // Update matrix upon successful JSON retrieval
            updateMatrix: function() {
                if(this.readyState == 4 && this.status == 200) {
                    response = this.responseText;
                    parsedJSON = JSON.parse(response);
                    cse = document.getElementById("cse-count");
                    ece = document.getElementById("ece-count");
                    me = document.getElementById("me-count");
                    bt = document.getElementById("bt-count");
                    cse.innerHTML = parsedJSON.CSE;
                    ece.innerHTML = parsedJSON.ECE;
                    me.innerHTML = parsedJSON.ME;
                    bt.innerHTML = parsedJSON.BT;
                    setTimeout(this.getJSON, 5000);
                }
            },

            // Decrement department seat count triggered upon 'submit' click
            decrementSeatCount: function() {
                var dropdownSelection = document.getElementById("dropdown");
                if (dropdownSelection.value == 'CSE') {
                    cse.innerHTML--;
                }
                else if(dropdownSelection.value == 'ECE') {
                    ece.innerHTML--;
                }
                else if(dropdownSelection.value == 'ME') {
                    me.innerHTML--;
                }
                else if(dropdownSelection.value == 'BT') {
                    bt.innerHTML--;
                }
                jsonarr = {'CSE': cse.innerHTML, 'ECE': ece.innerHTML, 'ME': me.innerHTML, 'BT': bt.innerHTML};
                this.getJSON();
            },

            // Throttle request timeout
            backoff: function() {
                console.log("Looks like we have failed!!!");
                setTimeout(this.getJSON, 2*n*1000);
                n=n*2;
                console.log("The value of n is"+ n);
            }
        }


    </script>

</head>

<body onload="obj.getJSON()">

    <section class="section">

        <div class="container">

            <h1 class="title has-text-centered">
                Seat allocation matrix
            </h1>

            <table class="table is-bordered" style="margin: 0 auto;">
                
                <thead>
                    <tr>
                        <th>CSE</th>
                        <th>ECE</th>
                        <th>ME</th>
                        <th>BT</th>
                    </tr>
                </thead>

                <tbody>
                    <tr>
                        <td id="cse-count"></td>
                        <td id="ece-count"></td>
                        <td id="me-count"></td>
                        <td id="bt-count"></td>
                    </tr>
                </tbody>

            </table>

            <div class="control has-text-centered py-4">

                <div class="select is-rounded px-2">
                    <select id="dropdown">
                        <option>CSE</option>
                        <option>ECE</option>
                        <option>ME</option>
                        <option>BT</option>
                    </select>
                </div>

                <a class="button is-rounded is-outlined" onclick="obj.decrementSeatCount()"><strong>Submit</strong></a>

            </div>

        </div>

    </section>

    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
</body>

</html>